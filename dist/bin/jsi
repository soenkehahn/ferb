#!/usr/bin/env bash

set -o errexit

mkdir -p ~/.jsi/project

if [ ! -f ~/.jsi/project/node_modules/.bin/babel-node ]; then
  (cd ~/.jsi/project; yarn add babel-cli babel-plugin-transform-flow-strip-types) 1>&2
fi

if [ ! -f ~/.jsi/project/node_modules/.bin/flow ]; then
  (cd ~/.jsi/project; yarn add flow-bin) 1>&2
fi

if [ ! -f ~/.jsi/project/.flowconfig ]; then
  (cd ~/.jsi/project; flow init) 1>&2
fi

if [ ! -d ~/.jsi/project/node_modules/babel-preset-env ]; then
  (cd ~/.jsi/project; yarn add babel-preset-env) 1>&2
fi

export NODE_PATH=~/.jsi/project/node_modules

cat $@ | (cd ~/.jsi/project; ./node_modules/.bin/flow check-contents --quiet) 1>&2

~/.jsi/project/node_modules/.bin/babel-node \
  --plugins 'transform-flow-strip-types' \
  --presets 'env' \
  $@
